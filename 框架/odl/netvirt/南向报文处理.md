---
title: 南向报文处理
date: 2019-08-22 17:09:22 
categories:
- 框架
- odl
- netvirt
tags: 
- openflow
- netvirt
description: 南向报文在netvirt中的处理 
export_on_save:
    html: true
html:
  embed_local_images: false
  embed_svg: true
  offline: false
  toc: false
  
---


## openflow处理流程
&emsp;&emsp;openflow中关于和设备连接有几个比较关键的类。这些类基本提供的ovs与设备连接的信息。
|              类              |
| ---------------------------- |
| DeviceContextImpl            |
| ContextChainHolderImpl       |
| SwitchConnectionProviderImpl |
| ConnectionAdapterImpl        |
| OpenFlowPluginProviderImpl   |


<details>
 <summary>openflow处理流程图</summary>

 ```plantuml
 @startuml
 title 南向报文处理
 Netty -> Netty:channelRead
 Netty -> AbstractConnectionAdapterStatistics:consume
 AbstractConnectionAdapterStatistics -> ConnectionAdapterImpl:consumeDeviceMessage
 ConnectionAdapterImpl -> OpenflowProtocolListenerFullImpl:onPacketInMessage
 note left
    对消息进行分类处理
 end note
 OpenflowProtocolListenerFullImpl -> DeviceContextImpl:processPacketInMessage
 DeviceContextImpl -> PacketReceivedTranslator:translate,消息pojo转换
 note left
    只有ovs的主处理消息
 end note
 PacketReceivedTranslator -> DeviceContextImpl:packetReceived pojo
 DeviceContextImpl -> DeviceContextImpl:handlePacketInMessage
 DeviceContextImpl -> NotificationService:offerNotification
 note left
    1:消息统计功能
    2：通过Notification发送消息
 end note
 @enduml
 ```
</details>

## 监听packet-received notification的类.
&emsp;&emsp;所有监听packet-received notification的类均实现 `PacketProcessingListener`接口。且分布在以下三个模块，具体信息见表格。曾出现故障，由于NotificationService在调用监听器时，监听器抛出异常没有被捕获，导致NotificationService服务崩溃，后续的报文处理异常。


|   模块   |             类             |                   处理的报文类型                    |
| -------- | -------------------------- | --------------------------------------------------- |
| openflow | LLDPDiscoveryListener      |                                                     |
| genius   | AlivenessMonitor           | 保活                                                |
| ^        | ArpUtilImpl                |                                                     |
| ^        | PacketInCounterHandler     | 统计报文                                            |
| neivirt  | DhcpPktHandler             | DHCP_TABLE（60）或 DHCP_TABLE_EXTERNAL_TUNNEL（18） |
| ^        | ElanPacketInHandler        | ELAN_SMAC_TABLE（50）                               |
| ^        | Ipv6PktHandler             | ipv6报文                                            |
| ^        | NaptPacketInHandler        | OUTBOUND_NAPT_TABLE（46）                           |
| ^        | SubnetRoutePacketInHandler | L3_SUBNET_ROUTE_TABLE(22)                           |




