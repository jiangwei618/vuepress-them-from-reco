---
title: 流表分析 
date: 2019-10-10 15:28:19
description: 流表分析
categories:
- 框架
- openstack
tags: 
- 
export_on_save:
    markdown: true
---
## table0
### write_metadata 
&emsp;lportTag 由 genious 中的IDManager 分配，在数据库operational/ietf-interfaces:interfaces-state表现为if-index。
```java 
 // class
 public final class FlowBasedServicesUtils {
     public static void installLportIngressFlow(BigInteger dpId, long portNo, Interface iface,
            List<ListenableFuture<Void>> futures, ManagedNewTransactionRunner txRunner, int lportTag) {
                BigInteger metadata = MetaDataUtil.getMetaDataForLPortDispatcher(lportTag, (short) 0, BigInteger.ZERO,isExternal(iface));
                BigInteger metadataMask = MetaDataUtil.getMetaDataMaskForLPortDispatcher(MetaDataUtil.METADATA_MASK_LPORT_TAG_SH_FLAG);
            }
 }

 // class
 public final class MetaDataUtil {
    public static BigInteger getMetaDataForLPortDispatcher(int lportTag, short serviceIndex,
                                                           BigInteger serviceMetaData, boolean isSHFlagSet) {
        int shBit = isSHFlagSet ? 1 : 0;
        return getServiceIndexMetaData(serviceIndex).or(getLportTagMetaData(lportTag)).or(serviceMetaData)
                .or(BigInteger.valueOf(shBit));
    }

    public static BigInteger getServiceIndexMetaData(int serviceIndex) {
        return new BigInteger("F", 16).and(BigInteger.valueOf(serviceIndex)).shiftLeft(60);
    }

    public static BigInteger getLportTagMetaData(int lportTag) {
        return new BigInteger("FFFFF", 16).and(BigInteger.valueOf(lportTag)).shiftLeft(40);
    }
 }
```
## table17
### match

```java 
 // class
 public final class FlowBasedServicesUtils {
    public static void installLPortDispatcherFlow(BigInteger dpId, BoundServices boundService, String interfaceName, WriteTransaction writeTransaction, int interfaceTag, short currentServiceIndex, short nextServiceIndex) {
        List<MatchInfo> matches = FlowBasedServicesUtils.getMatchInfoForDispatcherTable(interfaceTag,
                currentServiceIndex);
    }

    public static List<MatchInfo> getMatchInfoForDispatcherTable(int interfaceTag, short servicePriority) {
        List<MatchInfo> matches = new ArrayList<>();
        matches.add(new MatchMetadata(MetaDataUtil.getMetaDataForLPortDispatcher(interfaceTag, servicePriority),
                MetaDataUtil.getMetaDataMaskForLPortDispatcher()));
        return matches;
    }
 }

 // class
 public final class MetaDataUtil {
    public static BigInteger getMetaDataForLPortDispatcher(int lportTag, short serviceIndex) {
        return getServiceIndexMetaData(serviceIndex).or(getLportTagMetaData(lportTag));
    }

    public static BigInteger getServiceIndexMetaData(int serviceIndex) {
        return new BigInteger("F", 16).and(BigInteger.valueOf(serviceIndex)).shiftLeft(60);
    }

    public static BigInteger getLportTagMetaData(int lportTag) {
        return new BigInteger("FFFFF", 16).and(BigInteger.valueOf(lportTag)).shiftLeft(40);
    }
 }

```

### write_metadata



