---
title: 集群概述
date: 2019-09-18 09:58:55
description: 集群概述
categories:
  - 框架
  - odl
  - controller
tags:
  - odl
  - controller
  - owner

---


## 1. odl集群
odl的三节点集群完全依赖akka集群构建。采用gossip协议收敛，并实现集群故障自动诊断。
[akka官网集群介绍](https://doc.akka.io/docs/akka/current/common/cluster.html)
```plantuml
@startuml
title odl 三节点集群
 
!define leader rectangle  #3CB371
!define fllower rectangle  #lightgreen

leader clusterNode1
note left #red
  Leader
end note

fllower clusterNode2
fllower clusterNode3

clusterNode1 <-down->clusterNode2
clusterNode1 <-down->clusterNode3
clusterNode2 <-left->clusterNode3

center footer  gossip协议\n自动故障诊断
 
@enduml
``` 
## 2. shardManager
odl的每个节点均有一个shardManager。shardManager不组成集群，其主要职责如下
1. 负责处理本节点的分片创建
2. 负责接收集群节点的状态（cluster event ，eg：MemberUp），并触发数据库分片和ownershp动作
3. 持久化分片信息（persistShardList）
```plantuml
@startuml
title odl shardmanager
 
!define leader rectangle  #3CB371
!define fllower rectangle  #lightgreen
!define shard_manager1 rectangle  #yellow
!define shard_manager2 rectangle  #yellow
!define shard_manager3 rectangle  #yellow

leader clusterNode1
note left #red
  Leader
end note
fllower clusterNode2
fllower clusterNode3

shard_manager1 SM_config1
shard_manager2 SM_config2
shard_manager3 SM_config3

shard_manager1 SM_operational1
shard_manager2 SM_operational2
shard_manager3 SM_operational3

clusterNode1 <-down->clusterNode2
clusterNode1 <-down->clusterNode3
clusterNode2 <-left->clusterNode3

clusterNode1 -up->  SM_config1
clusterNode2 -down->  SM_config2
clusterNode3 -down->  SM_config3


clusterNode1 -up->  SM_operational1
clusterNode2 -down->  SM_operational2
clusterNode3 -down->  SM_operational3


@enduml
``` 



# datastore shard
shardmanager会根据module-shards.conf中的配置创建shard，<strong> 如果replicas不存在A节点，则A不创建对应的shard </strong>。不通的节点的同一分片通过raft算法选出对应的leader 和 fllower。(shardmanager config 和operational 均会创建分片)
```plantuml
@startuml
title odl shardmanager
 
!define leader rectangle  #3CB371
!define fllower rectangle  #lightgreen
!define shard_manager1 rectangle  #yellow
!define shard_manager2 rectangle  #yellow
!define shard_manager3 rectangle  #yellow
!define shard_leader rectangle  #8B8989
!define shard_fllower rectangle  #EBEBEB

leader clusterNode1
note left #red
  Leader
end note
fllower clusterNode2
fllower clusterNode3

shard_manager1 shardmanager1
shard_manager2 shardmanager2
shard_manager3 shardmanager3

clusterNode1 <-down->clusterNode2
clusterNode1 <-down->clusterNode3
clusterNode2 <-left->clusterNode3

clusterNode1 -up->  shardmanager1
clusterNode2 -right->  shardmanager2
clusterNode3 -left->  shardmanager3

shard_fllower shard1_1
shard_leader shard2_1
note left #red
  Leader
end note
shard_fllower shard3_1
shardmanager1 -up-> shard1_1
shardmanager2 -down-> shard2_1
shardmanager3 -down-> shard3_1


shard_fllower shard1_2
shard_leader shard3_2
shard_fllower shard2_2

shardmanager1 -up-> shard1_2
shardmanager2 -down-> shard2_2
shardmanager3 -down-> shard3_2


@enduml
``` 

## 3. entityownership shard
entityownership shad 负责处理用户级别的选主，例如netconf和设备的链接主备。entityownership的选主有几种策略，FirstCandidateSelectionStrategy、LeastLoadedCandidateSelectionStrategy、LastCandidateSelectionStrategy。entityownership shard只存在于shard manager operational 下.entityownership shad 本身继承自shard，其选主也是通过raft算法。
```plantuml
@startuml
title odl shardmanager
 
!define leader rectangle  #3CB371
!define fllower rectangle  #lightgreen
!define shard_manager1 rectangle  #yellow
!define shard_manager2 rectangle  #yellow
!define shard_manager3 rectangle  #yellow
!define shard_leader rectangle  #8B8989
!define shard_fllower rectangle  #EBEBEB

leader clusterNode1
note left #red
  Leader
end note
fllower clusterNode2
fllower clusterNode3

shard_manager1 SM_operational1
shard_manager2 SM_operational2
shard_manager3 SM_operational3

clusterNode1 <-down->clusterNode2
clusterNode1 <-down->clusterNode3
clusterNode2 <-left->clusterNode3

clusterNode1 -up->  SM_operational1
clusterNode2 -right->  SM_operational2
clusterNode3 -left->  SM_operational3

shard_fllower entityownership1
shard_leader entityownership2
shard_fllower entityownership3

SM_operational1 -up->entityownership1
SM_operational2 -right->entityownership2
SM_operational3 -left->entityownership3

@enduml
``` 