---
title: 网络处理
date: 2017-01-07T22:55:54.000Z
description: netvirt中的网络部分逻辑
categories:
    - 框架
    - odl
    - netvirt
tags:
    - 网络处理
---  
  
  
##  1. 常规步骤
  
  
###  1.1. add
  
  
---
  
<p style="text-align: center;"><Strong>第一步：添加网络</Strong></p>
  
当北向创建网络 api 被调用，neutron 写入 config neutron/network/network 库，并触发 datastore 监听。
  
- neutronVpn/NeutronNetworkChangeListener：在进行一些基础检查后，创建 elanInstance（一个网络对应一个 elan instance）。创建 elanInstance 时会查询 config elan-instances/elan-instance 库，如果存在，则返回，如果不存在则创建 enlanInstace 数据，写入 config 库<br/><br/>
  
- ipv6Service/NeutronNetworkChangeListener：ipv6 相关，暂不考虑<br/><br/>
  
- qosservice/QosNeutronNetworkChangeListener：qos 相关，暂不考虑<br/><br/>
  
  
  
<details>
 <summary>第一步：网络创建</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c990.png?0.6706295074037605)  
  
</details>
  
---
  
<p style="text-align: center;"><Strong>第二步：创建elan</Strong></p>
  
&emsp;&emsp;当 elan-instances/elan-instance config 库被写入数据后，开始触发 elan 创建的流程。在创建 elan 的过程中，会写入其他的多个 operational 数据库，不过这些数据库都没有监听器，仅仅作为数据存储所用。
&emsp;&emsp;创建 elan-instances/elan-instance 时还会更新 elan-instances/elan-instance config 库
  
  
  
<details>
 <summary>第二步：elan创建</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c991.png?0.09479090098445275)  
  
</details>
  
  
  
<details>
 <summary>第二步：elan创建续</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c992.png?0.5706852024214393)  
  
</details>
  
---
  
<p style="text-align: center;"><Strong>第三步：elan 更新</Strong></p>
  
&emsp;&emsp;当 elan-instances/elan-instance config 库被更新数据后，开始触发 elan 更新的流程。
  
  
  
<details>
 <summary>第三步：elan更新</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c993.png?0.06767509568162611)  
</details>
  
<details>
 <summary>第三步：elan 更新续</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c994.png?0.90867343169832)  
  
</details>
  
###  1.2. update
  
  
&emsp;&emsp;当北向 api 更新 neutron/network/network 后，NeutronNetworkChangeListener 不作其他操作.
  
<details>
 <summary>网络更新</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c995.png?0.22325224359450924)  
</details>
  
###  1.3. remove
  
  
---
  
<p style="text-align: center;"><Strong>第一步：删除网络</Strong></p>
&emsp;&emsp;删除数据库中的elan instance数据后，触发相关的其他流程。
  
<details>
 <summary>网络删除</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c996.png?0.06093478665507068)  
  
</details>
  
---
  
<p style="text-align: center;"><Strong>第二步：elan删除</Strong></p>
  
##  2. vlan 网络创建
  
  
&emsp;&emsp;vlan 网络创建时，会提前创建一个 elan interface 到业务口的映射。（odl 原生代码中没有）在软件 vtep 环境下创建 vlan 网络或者硬件 vtep 环境下创建网络（overlay 会将 openstack 创建的 vxlan 网络修改为 vlan 网络）会被触发。
  
<p style="text-align: center;"><Strong>第一步：vlan 网络创建</Strong></p>
  
<details>
 <summary>vlan网络创建</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c997.png?0.18540546604412622)  
</details>
  
&emsp;&emsp;在上图中，有几处会写数据库的操作，因此，会触发其他监听程序。
  
&emsp;&emsp;上图中 trunk 口可 elan interface 的解释如下。其中`IfmConstants.OF_URI_SEPARATOR=":"`；`parentRef = dpnid:业务口`
  
| 端口性质        | 名称规则                                                   | 示例                         |
| --------------- | ---------------------------------------------------------- | ---------------------------- |
| trunk           | parentRef + IfmConstants.OF_URI_SEPARATOR + "trunk"        | 203100663178074:ens192:trunk |
| elan interfaced | parentRef + IfmConstants.OF_URI_SEPARATOR + segmentationId | 62457717962162:ens192:100    |
  
---
  
<p style="text-align: center;"><Strong>第二步：ietf interface 创建</Strong></p>
  
<details>
 <summary>ietf interface创建</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c998.png?0.2682502862363676)  
  
</details>
  
---
  
<p style="text-align: center;"><Strong>第三步：elan interface 创建</Strong></p>
  
<details>
 <summary>elan interface创建</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c999.png?0.8076382134126232)  
  
</details>
  
---
  
<p style="text-align: center;"><Strong>第三步续：elan interface 创建</Strong></p>
  
<details>
 <summary>elan interface创建续</summary>
  

![](../../../../images/c34601134b04ed07944912103f1d3c9910.png?0.8486521307059631)  
  
</details>
  
<details>
 <summary>创建vlan 网络 下发流表示例</summary>
  
 ```text
 table=0, priority=4,in_port=3,vlan_tci=0x0000/0x1fff actions=write_metadata:0x90000000001/0xffffff0000000001,goto_table:17
 table=0, priority=10,in_port=3,dl_vlan=10 actions=pop_vlan,write_metadata:0xa0000000001/0xffffff0000000001,goto_table:17
 table=17, priority=10,metadata=0xa0000000000/0xffffff0000000000 actions=load:0xa->NXM_NX_REG1[0..19], load:0x138a->NXM_NX_REG7[0..15],write_metadata:0xa0000a138a000000/0xfffffffffffffffe,goto_table:43
 table=52, priority=5,metadata=0x138a000000/0xffff000001 actions=write_actions(group:210004)
 table=52, priority=5,metadata=0x138a000001/0xffff000001 actions=write_actions(group:210003)
 table=55, priority=10,tun_id=0xa,metadata=0xa0000000000/0xfffff0000000000 actions=drop
 table=55, priority=9,tun_id=0xa actions=load:0xa00->NXM_NX_REG6[],resubmit(,220)
 table=220, priority=10,reg6=0x900,metadata=0x1/0x1 actions=drop
 table=220, priority=10,reg6=0xa00,metadata=0x1/0x1 actions=drop
 table=220, priority=9,reg6=0x900 actions=output:3
 table=220, priority=9,reg6=0xa00 actions=push_vlan:0x8100,set_field:4106->vlan_vid,output:3
 ```
 ```text
 group_id=210003,type=all
 group_id=210004,type=all,bucket=actions=group:210003,bucket=actions=load:0xa00->NXM_NX_REG6[],resubmit(,220)
 ```
  
</details>
  