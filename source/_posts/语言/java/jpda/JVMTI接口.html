---
title: JVMTI:Java 虚拟机工具接口
date: 2019-08-26 10:57:34
categories:
  - 语言
  - java
  - jpda
tags:
  - jpda
description: JVMTI:Java 虚拟机工具接口
export_on_save:
  html: true
html:
  embed_local_images: false
  embed_svg: true
  offline: false
  toc: false
---
<!DOCTYPE html><html><head>
      <title>JVMTI:Java &#x865A;&#x62DF;&#x673A;&#x5DE5;&#x5177;&#x63A5;&#x53E3;</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css">
      
      

      
      
      
      
      
      

      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <p>&#x2003;&#x2003;JVMTI&#xFF08;Java Virtual Machine Tool Interface&#xFF09;&#x5373;&#x6307; Java &#x865A;&#x62DF;&#x673A;&#x5DE5;&#x5177;&#x63A5;&#x53E3;&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x5957;&#x7531;&#x865A;&#x62DF;&#x673A;&#x76F4;&#x63A5;&#x63D0;&#x4F9B;&#x7684; native &#x63A5;&#x53E3;&#xFF0C;&#x5B83;&#x5904;&#x4E8E;&#x6574;&#x4E2A; JPDA &#x4F53;&#x7CFB;&#x7684;&#x6700;&#x5E95;&#x5C42;&#xFF0C;&#x6240;&#x6709;&#x8C03;&#x8BD5;&#x529F;&#x80FD;&#x672C;&#x8D28;&#x4E0A;&#x90FD;&#x9700;&#x8981;&#x901A;&#x8FC7; JVMTI &#x6765;&#x63D0;&#x4F9B;&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x4E9B;&#x63A5;&#x53E3;&#xFF0C;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x4E0D;&#x4EC5;&#x8C03;&#x8BD5;&#x5728;&#x8BE5;&#x865A;&#x62DF;&#x673A;&#x4E0A;&#x8FD0;&#x884C;&#x7684; Java &#x7A0B;&#x5E8F;&#xFF0C;&#x8FD8;&#x80FD;&#x67E5;&#x770B;&#x5B83;&#x4EEC;&#x8FD0;&#x884C;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x8BBE;&#x7F6E;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#xFF0C;&#x63A7;&#x5236;&#x67D0;&#x4E9B;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF0C;&#x4ECE;&#x800C;&#x4F18;&#x5316;&#x7A0B;&#x5E8F;&#x6027;&#x80FD;&#x3002;</p>
<p>&#x2003;&#x2003;JVMTI &#x5E76;&#x4E0D;&#x4E00;&#x5B9A;&#x5728;&#x6240;&#x6709;&#x7684; Java &#x865A;&#x62DF;&#x673A;&#x4E0A;&#x90FD;&#x6709;&#x5B9E;&#x73B0;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x865A;&#x62DF;&#x673A;&#x7684;&#x5B9E;&#x73B0;&#x4E5F;&#x4E0D;&#x5C3D;&#x76F8;&#x540C;&#x3002;&#x4E0D;&#x8FC7;&#x5728;&#x4E00;&#x4E9B;&#x4E3B;&#x6D41;&#x7684;&#x865A;&#x62DF;&#x673A;&#x4E2D;&#xFF0C;&#x6BD4;&#x5982; Sun &#x548C; IBM&#xFF0C;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x5F00;&#x6E90;&#x7684;&#x5982; Apache Harmony DRLVM &#x4E2D;&#xFF0C;&#x90FD;&#x63D0;&#x4F9B;&#x4E86;&#x6807;&#x51C6; JVMTI &#x5B9E;&#x73B0;&#x3002;</p>
<h2 class="mume-header" id="1-jvmti-%E4%B8%8E-agent-%E7%9A%84%E5%85%B3%E7%B3%BB">1. JVMTI &#x4E0E; Agent &#x7684;&#x5173;&#x7CFB;</h2>

<p>&#x2003;&#x2003;JVM TI is implemented by HotSpot and allows a native code &#x2018;agent&#x2019; to inspect and modify the state of the JVM.&#xFF08;&#x53C2;&#x770B;http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#battach &#x4E2D;&#x7684;&#x8BF4;&#x660E;&#xFF09;<br>
<strong>Agent &#x5373; JVMTI &#x7684;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5B83;&#x548C;&#x6267;&#x884C; Java &#x7A0B;&#x5E8F;&#x7684;&#x865A;&#x62DF;&#x673A;&#x8FD0;&#x884C;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x4E0A;&#xFF0C;&#x901A;&#x8FC7;&#x8C03;&#x7528; JVMTI &#x63D0;&#x4F9B;&#x7684;&#x63A5;&#x53E3;&#x548C;&#x865A;&#x62DF;&#x673A;&#x4EA4;&#x4E92;&#xFF0C;&#x8D1F;&#x8D23;&#x83B7;&#x53D6;&#x5E76;&#x8FD4;&#x56DE;&#x5F53;&#x524D;&#x865A;&#x62DF;&#x673A;&#x7684;&#x72B6;&#x6001;&#x6216;&#x8005;&#x8F6C;&#x53D1;&#x63A7;&#x5236;&#x547D;&#x4EE4;</strong>&#x3002;&#x628A; Agent &#x7F16;&#x8BD1;&#x6210;&#x4E00;&#x4E2A;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;&#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5728; Java &#x7A0B;&#x5E8F;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x6765;&#x52A0;&#x8F7D;&#x5B83;&#xFF08;&#x542F;&#x52A8;&#x52A0;&#x8F7D;&#x6A21;&#x5F0F;&#xFF09;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5728; Java 5 &#x4E4B;&#x540E;&#x4F7F;&#x7528;&#x8FD0;&#x884C;&#x65F6;&#x52A0;&#x8F7D;&#xFF08;&#x6D3B;&#x52A8;&#x52A0;&#x8F7D;&#x6A21;&#x5F0F;&#xFF09;&#x3002;</p>
<p>&#x2003;&#x2003;&#x603B;&#x7ED3;&#xFF1A;&#x4E2A;&#x4EBA;&#x611F;&#x89C9;&#xFF0C;JVMTI &#x4E00;&#x79CD;&#x64CD;&#x4F5C; JVM &#x7684;&#x89C4;&#x8303;&#x4E0E;&#x63A5;&#x53E3;&#x3002;&#x5F00;&#x53D1;&#x8005;&#x901A;&#x8FC7; Agent &#x7684;&#x65B9;&#x5F0F;&#x4F7F;&#x7528;&#x8BE5;&#x5957;&#x63A5;&#x53E3;&#x3002;&#x540C;&#x65F6; Agent &#x7684;&#x903B;&#x8F91;&#x8FD0;&#x884C;&#x673A;&#x5236;&#x4F9D;&#x8D56;&#x4E0E; JVMTI &#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x73B0;&#x3002;</p>
<h2 class="mume-header" id="2-gent-%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B">2. gent &#x7684;&#x5DE5;&#x4F5C;&#x8FC7;&#x7A0B;</h2>

<p>&#x2003;&#x2003;&#x6211;&#x4EEC;&#x4F7F;&#x7528; JVMTI &#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x8BBE;&#x7F6E; JVMTI &#x73AF;&#x5883;&#xFF0C;&#x76D1;&#x542C;&#x865A;&#x62DF;&#x673A;&#x6240;&#x4EA7;&#x751F;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x4EE5;&#x53CA;&#x5728;&#x67D0;&#x4E9B;&#x4E8B;&#x4EF6;&#x4E0A;&#x52A0;&#x4E0A;&#x6211;&#x4EEC;&#x6240;&#x5E0C;&#x671B;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x2003;&#x2003;Agent &#x7684;&#x4E3B;&#x8981;&#x529F;&#x80FD;&#x662F;&#x901A;&#x8FC7;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x5728;&#x865A;&#x62DF;&#x673A;&#x4E0A;&#x8BBE;&#x7F6E;&#x7684;&#x56DE;&#x8C03;&#xFF08;callback&#xFF09;&#x51FD;&#x6570;&#x5B8C;&#x6210;&#x7684;&#xFF0C;&#x4E00;&#x65E6;&#x67D0;&#x4E9B;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#xFF0C;Agent &#x6240;&#x8BBE;&#x7F6E;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5C31;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x6765;&#x5B8C;&#x6210;&#x7279;&#x5B9A;&#x7684;&#x9700;&#x6C42;&#x3002;</p>
<h2 class="mume-header" id="3-jvm-%E5%90%AF%E5%8A%A8%E6%97%B6%E5%8A%A0%E8%BD%BD">3. JVM &#x542F;&#x52A8;&#x65F6;&#x52A0;&#x8F7D;</h2>

<p>&#x2003;&#x2003;Agent &#x662F;&#x5728; Java &#x865A;&#x62DF;&#x673A;&#x542F;&#x52A8;&#x4E4B;&#x65F6;&#x52A0;&#x8F7D;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x52A0;&#x8F7D;&#x5904;&#x4E8E;&#x865A;&#x62DF;&#x673A;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65E9;&#x671F;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x65F6;&#x95F4;&#x70B9;&#x4E0A;&#xFF1A;</p>
<ol>
<li>&#x6240;&#x6709;&#x7684; Java &#x7C7B;&#x90FD;&#x672A;&#x88AB;&#x521D;&#x59CB;&#x5316;&#xFF1B;</li>
<li>&#x6240;&#x6709;&#x7684;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#x90FD;&#x672A;&#x88AB;&#x521B;&#x5EFA;&#xFF1B;</li>
<li>&#x56E0;&#x800C;&#xFF0C;&#x6CA1;&#x6709;&#x4EFB;&#x4F55; Java &#x4EE3;&#x7801;&#x88AB;&#x6267;&#x884C;&#xFF1B;&#x4F46;&#x5728;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x53EF;&#x4EE5;&#xFF1A;<br>
&#x64CD;&#x4F5C; JVMTI &#x7684; Capability &#x53C2;&#x6570;&#xFF1B;<br>
&#x4F7F;&#x7528;&#x7CFB;&#x7EDF;&#x53C2;&#x6570;&#xFF1B;</li>
</ol>
<h2 class="mume-header" id="4-jvm-%E8%BF%90%E8%A1%8C%E6%80%81%E5%8A%A0%E8%BD%BD">4. JVM &#x8FD0;&#x884C;&#x6001;&#x52A0;&#x8F7D;</h2>

<p>&#x57FA;&#x4E8E; jvm attach &#x673A;&#x5236;&#x3002;<br>
&#x5173;&#x4E8E; dynamic attach: Dynamic Attach. This is a Sun private mechanism that allows an external process to start a thread in HotSpot that can then be used to launch an agent to run in that HotSpot, and to send information about the state of HotSpot back to the external process.(&#x53C2;&#x89C1; <a href="http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#battach">http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#battach</a> )</p>
<p>&#x2003;&#x2003;++attach &#x662F; Sun &#x7684;&#x79C1;&#x6709;&#x5B9E;&#x73B0;&#xFF08;&#x5E76;&#x4E0D;&#x662F;&#x6240;&#x6709;&#x7684; jvm &#x90FD;&#x63D0;&#x4F9B;&#x8BE5;&#x529F;&#x80FD;&#xFF09;&#xFF0C;&#x8BE5;&#x673A;&#x5236;&#x5141;&#x8BB8; &#x5916;&#x90E8;&#x8FDB;&#x7A0B; &#x5728; JVM&#xFF08;&#x8BE5; JVM &#x6307;&#x8FD0;&#x884C;&#x88AB;&#x76D1;&#x63A7;&#x3001;&#x9700;&#x8981;&#x88AB;&#x64CD;&#x63A7;&#x7684; Java &#x7A0B;&#x5E8F;&#x7684; JVM&#xFF09;&#x4E2D;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;,&#x8BE5;&#x7EBF;&#x7A0B;&#x968F;&#x540E;&#x4F1A;&#x542F;&#x52A8;&#x52A0;&#x8F7D; agent&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x672C; JVM &#x7684;&#x72B6;&#x6001;&#x53D1;&#x9001;&#x7ED9; &#x5916;&#x90E8;&#x8FDB;&#x7A0B;&#x3002;++</p>
<h2 class="mume-header" id="5-jvmtiagent-%E7%A4%BA%E4%BE%8B">5. JVMTIAgent &#x793A;&#x4F8B;</h2>

<p>&#x2003;&#x2003;&#x8BE5; Agent &#x901A;&#x8FC7;&#x76D1;&#x542C; JVMTI_EVENT_METHOD_ENTRY &#x4E8B;&#x4EF6;&#xFF0C;&#x6CE8;&#x518C;&#x5BF9;&#x5E94;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x6765;&#x54CD;&#x5E94;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#xFF0C;&#x6765;&#x8F93;&#x51FA;&#x6240;&#x6709;&#x88AB;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x540D;&#x3002;</p>
<p>&#x2003;&#x2003;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x90FD;&#x5728; MethodTraceAgent &#x8FD9;&#x4E2A;&#x7C7B;&#x91CC;&#x63D0;&#x4F9B;&#x3002;&#x6309;&#x7167;&#x987A;&#x5E8F;&#xFF0C;&#x4ED6;&#x4F1A;&#x5904;&#x7406;&#x73AF;&#x5883;&#x521D;&#x59CB;&#x5316;&#x3001;&#x53C2;&#x6570;&#x89E3;&#x6790;&#x3001;&#x6CE8;&#x518C;&#x529F;&#x80FD;&#x3001;&#x6CE8;&#x518C;&#x4E8B;&#x4EF6;&#x54CD;&#x5E94;&#xFF0C;&#x6BCF;&#x4E2A;&#x529F;&#x80FD;&#x90FD;&#x88AB;&#x62BD;&#x8C61;&#x5728;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x51FD;&#x6570;&#x91CC;&#x3002;</p>
<pre data-role="codeBlock" data-info="C" class="language-c">MethodTraceAgent<span class="token punctuation">.</span>h

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;jvmti.h&quot;</span></span>

class AgentException
<span class="token punctuation">{</span>
 public<span class="token operator">:</span>
	<span class="token function">AgentException</span><span class="token punctuation">(</span>jvmtiError err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		m_error <span class="token operator">=</span> err<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token function">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;AgentException&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	jvmtiError <span class="token function">ErrCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token function">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> m_error<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

 private<span class="token operator">:</span>
	jvmtiError m_error<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


class MethodTraceAgent
<span class="token punctuation">{</span>
 public<span class="token operator">:</span>

	<span class="token function">MethodTraceAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">MethodTraceAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token function">ParseOptions</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token function">AddCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token function">RegisterEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">static</span> <span class="token keyword">void</span> JNICALL <span class="token function">HandleMethodEntry</span><span class="token punctuation">(</span>jvmtiEnv<span class="token operator">*</span> jvmti<span class="token punctuation">,</span> JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span> jthread thread<span class="token punctuation">,</span> jmethodID method<span class="token punctuation">)</span><span class="token punctuation">;</span>

 private<span class="token operator">:</span>
	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">CheckException</span><span class="token punctuation">(</span>jvmtiError error<span class="token punctuation">)</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">// &#x53EF;&#x4EE5;&#x6839;&#x636E;&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x6269;&#x5C55;&#x5BF9;&#x5E94;&#x7684;&#x5F02;&#x5E38;&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x505A;&#x7B80;&#x5355;&#x5904;&#x7406;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> JVMTI_ERROR_NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			throw <span class="token function">AgentException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">static</span> jvmtiEnv <span class="token operator">*</span> m_jvmti<span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token keyword">char</span><span class="token operator">*</span> m_filter<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><pre data-role="codeBlock" data-info="C" class="language-c">MethodTraceAgent<span class="token punctuation">.</span>cpp

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;MethodTraceAgent.h&quot;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;jvmti.h&quot;</span></span>

using namespace std<span class="token punctuation">;</span>

jvmtiEnv<span class="token operator">*</span> MethodTraceAgent<span class="token operator">::</span>m_jvmti <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">char</span><span class="token operator">*</span> MethodTraceAgent<span class="token operator">::</span>m_filter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

MethodTraceAgent<span class="token operator">::</span><span class="token operator">~</span><span class="token function">MethodTraceAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// &#x5FC5;&#x987B;&#x91CA;&#x653E;&#x5185;&#x5B58;&#xFF0C;&#x9632;&#x6B62;&#x5185;&#x5B58;&#x6CC4;&#x9732;</span>
    m_jvmti<span class="token operator">-&gt;</span><span class="token function">Deallocate</span><span class="token punctuation">(</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>m_filter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MethodTraceAgent<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span><span class="token punctuation">{</span>
    jvmtiEnv <span class="token operator">*</span>jvmti <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	jint ret <span class="token operator">=</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetEnv</span><span class="token punctuation">(</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jvmti<span class="token punctuation">)</span><span class="token punctuation">,</span> JVMTI_VERSION_1_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> JNI_OK <span class="token operator">||</span> jvmti <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		throw <span class="token function">AgentException</span><span class="token punctuation">(</span>JVMTI_ERROR_INTERNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	m_jvmti <span class="token operator">=</span> jvmti<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MethodTraceAgent<span class="token operator">::</span><span class="token function">ParseOptions</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> size_t len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>

  	<span class="token comment">// &#x5FC5;&#x987B;&#x505A;&#x597D;&#x5185;&#x5B58;&#x590D;&#x5236;&#x5DE5;&#x4F5C;</span>
	jvmtiError error<span class="token punctuation">;</span>
    error <span class="token operator">=</span> m_jvmti<span class="token operator">-&gt;</span><span class="token function">Allocate</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_filter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CheckException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_filter<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x53EF;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x8FDB;&#x884C;&#x53C2;&#x6570;&#x89E3;&#x6790;&#x7684;&#x5DE5;&#x4F5C;</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MethodTraceAgent<span class="token operator">::</span><span class="token function">AddCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x73AF;&#x5883;</span>
    jvmtiCapabilities caps<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>caps<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>caps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    caps<span class="token punctuation">.</span>can_generate_method_entry_events <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// &#x8BBE;&#x7F6E;&#x5F53;&#x524D;&#x73AF;&#x5883;</span>
    jvmtiError error <span class="token operator">=</span> m_jvmti<span class="token operator">-&gt;</span><span class="token function">AddCapabilities</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>caps<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CheckException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MethodTraceAgent<span class="token operator">::</span><span class="token function">RegisterEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token function">throw</span><span class="token punctuation">(</span>AgentException<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;</span>
    jvmtiEventCallbacks callbacks<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>callbacks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    callbacks<span class="token punctuation">.</span>MethodEntry <span class="token operator">=</span> <span class="token operator">&amp;</span>MethodTraceAgent<span class="token operator">::</span>HandleMethodEntry<span class="token punctuation">;</span>

    <span class="token comment">// &#x8BBE;&#x7F6E;&#x56DE;&#x8C03;&#x51FD;&#x6570;</span>
    jvmtiError error<span class="token punctuation">;</span>
    error <span class="token operator">=</span> m_jvmti<span class="token operator">-&gt;</span><span class="token function">SetEventCallbacks</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>callbacks<span class="token punctuation">,</span> static_cast<span class="token operator">&lt;</span>jint<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CheckException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// &#x5F00;&#x542F;&#x4E8B;&#x4EF6;&#x76D1;&#x542C;</span>
	error <span class="token operator">=</span> m_jvmti<span class="token operator">-&gt;</span><span class="token function">SetEventNotificationMode</span><span class="token punctuation">(</span>JVMTI_ENABLE<span class="token punctuation">,</span> JVMTI_EVENT_METHOD_ENTRY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CheckException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> JNICALL MethodTraceAgent<span class="token operator">::</span><span class="token function">HandleMethodEntry</span><span class="token punctuation">(</span>jvmtiEnv<span class="token operator">*</span> jvmti<span class="token punctuation">,</span> JNIEnv<span class="token operator">*</span> jni<span class="token punctuation">,</span> jthread thread<span class="token punctuation">,</span> jmethodID method<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	try <span class="token punctuation">{</span>
        jvmtiError error<span class="token punctuation">;</span>
        jclass clazz<span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">;</span>
		<span class="token keyword">char</span><span class="token operator">*</span> signature<span class="token punctuation">;</span>

		<span class="token comment">// &#x83B7;&#x5F97;&#x65B9;&#x6CD5;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;</span>
        error <span class="token operator">=</span> m_jvmti<span class="token operator">-&gt;</span><span class="token function">GetMethodDeclaringClass</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CheckException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// &#x83B7;&#x5F97;&#x7C7B;&#x7684;&#x7B7E;&#x540D;</span>
        error <span class="token operator">=</span> m_jvmti<span class="token operator">-&gt;</span><span class="token function">GetClassSignature</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>signature<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CheckException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// &#x83B7;&#x5F97;&#x65B9;&#x6CD5;&#x540D;&#x5B57;</span>
        error <span class="token operator">=</span> m_jvmti<span class="token operator">-&gt;</span><span class="token function">GetMethodName</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CheckException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// &#x6839;&#x636E;&#x53C2;&#x6570;&#x8FC7;&#x6EE4;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x65B9;&#x6CD5;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>m_filter <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>m_filter<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		cout <span class="token operator">&lt;&lt;</span> signature<span class="token operator">&lt;&lt;</span> <span class="token string">&quot; -&gt; &quot;</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;(..)&quot;</span><span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

        <span class="token comment">// &#x5FC5;&#x987B;&#x91CA;&#x653E;&#x5185;&#x5B58;&#xFF0C;&#x907F;&#x514D;&#x5185;&#x5B58;&#x6CC4;&#x9732;</span>
        error <span class="token operator">=</span> m_jvmti<span class="token operator">-&gt;</span><span class="token function">Deallocate</span><span class="token punctuation">(</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">CheckException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        error <span class="token operator">=</span> m_jvmti<span class="token operator">-&gt;</span><span class="token function">Deallocate</span><span class="token punctuation">(</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">CheckException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>AgentException<span class="token operator">&amp;</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Error when enter HandleMethodEntry: &quot;</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; [&quot;</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">ErrCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x2003;&#x2003;Agent_OnLoad &#x51FD;&#x6570;&#x4F1A;&#x5728; Agent &#x88AB;&#x52A0;&#x8F7D;&#x7684;&#x65F6;&#x5019;&#x521B;&#x5EFA;&#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x5E76;&#x4F9D;&#x6B21;&#x8C03;&#x7528;&#x4E0A;&#x8FF0;&#x5404;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A; Agent &#x7684;&#x529F;&#x80FD;&#x3002;Agent_OnUnload &#x51FD;&#x6570;&#xFF0C;&#x5728; agent &#x5378;&#x8F7D;&#x65F6;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x2003;&#x2003;(&#x901A;&#x8FC7;&#x5728; vm &#x53C2;&#x6570;&#x91CC; &#x52A0;&#x4E0A;-agentlib&#xFF0C;&#x5219;&#x4F1A; VM &#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x6267;&#x884C; VM JVMTIAgent &#x7684; Agent_OnLoad &#x51FD;&#x6570; &#xFF09;</p>
<p>&#x2003;&#x2003;&#xFF08;Agent_OnAttach &#x51FD;&#x6570;&#xFF1A;&#x5982;&#x679C; agent &#x4E0D;&#x662F;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x52A0;&#x8F7D;&#x7684;&#xFF0C;&#x800C;&#x662F;&#x6211;&#x4EEC;&#x5148; attach &#x5230;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x4E0A;&#xFF0C;&#x7136;&#x540E;&#x7ED9;&#x5BF9;&#x5E94;&#x7684;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x53D1;&#x9001; load &#x547D;&#x4EE4;&#x6765;&#x52A0;&#x8F7D;&#xFF0C;&#x5219;&#x5728;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x4E2D;&#x4F1A;&#x8C03;&#x7528; Agent_OnAttach &#x51FD;&#x6570;&#x3002;&#xFF09;</p>
<pre data-role="codeBlock" data-info="C" class="language-c">Main<span class="token punctuation">.</span>cpp

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;MethodTraceAgent.h&quot;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;jvmti.h&quot;</span></span>

using namespace std<span class="token punctuation">;</span>

JNIEXPORT jint JNICALL <span class="token function">Agent_OnLoad</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>options<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reserved<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Agent_OnLoad(&quot;</span> <span class="token operator">&lt;&lt;</span> vm <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;)&quot;</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    try<span class="token punctuation">{</span>

        MethodTraceAgent<span class="token operator">*</span> agent <span class="token operator">=</span> new <span class="token function">MethodTraceAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		agent<span class="token operator">-&gt;</span><span class="token function">Init</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        agent<span class="token operator">-&gt;</span><span class="token function">ParseOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        agent<span class="token operator">-&gt;</span><span class="token function">AddCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        agent<span class="token operator">-&gt;</span><span class="token function">RegisterEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>AgentException<span class="token operator">&amp;</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Error when enter HandleMethodEntry: &quot;</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; [&quot;</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">ErrCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> JNI_ERR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> JNI_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Agent_OnUnload</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Agent_OnUnload(&quot;</span> <span class="token operator">&lt;&lt;</span> vm <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;)&quot;</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>&#x2003;&#x2003;Agent &#x7F16;&#x8BD1;&#x548C;&#x8FD0;&#x884C;</p>
<pre data-role="codeBlock" data-info class="language-"><code>g++ -I${JAVA_HOME}/include/ -I${JAVA_HOME}/include/linux
MethodTraceAgent.cpp Main.cpp -fPIC -shared -o libagent.so
</code></pre><p>&#x7528;&#x4E8E;&#x6D4B;&#x8BD5; Java &#x7A0B;&#x5E8F;&#xFF0C;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7C7B;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="C" class="language-c">public class MethodTraceTest<span class="token punctuation">{</span>

	public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
		MethodTraceTest test <span class="token operator">=</span> new <span class="token function">MethodTraceTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		test<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		test<span class="token punctuation">.</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	public <span class="token keyword">void</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=&gt; Call first()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	public <span class="token keyword">void</span> <span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=&gt; Call second()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x8FD0;&#x884C; Java &#x7A0B;&#x5E8F;&#xFF0C;&#x5E76;&#x6307;&#x5B9A; Agent</p>
<p>java -agentlib:Agent=first MethodTraceTest</p>
<p>&#x2003;&#x2003;&#x5F53;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x5230;&#x5230; MethodTraceTest &#x7684; first &#x65B9;&#x6CD5;&#x662F;&#xFF0C;Agent &#x4F1A;&#x8F93;&#x51FA;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#x3002;&#x201C; first &#x201D;&#x662F; Agent &#x8FD0;&#x884C;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x6307;&#x5B9A;&#x8BDD;&#xFF0C;&#x6240;&#x6709;&#x7684;&#x8FDB;&#x5165;&#x65B9;&#x6CD5;&#x7684;&#x89E6;&#x53D1;&#x7684;&#x4E8B;&#x4EF6;&#x90FD;&#x4F1A;&#x88AB;&#x8F93;&#x51FA;&#xFF0C;&#x5982;&#x679C;&#x8BFB;&#x8005;&#x628A;&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x53BB;&#x6389;&#x518D;&#x8FD0;&#x884C;&#x7684;&#x8BDD;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x5728;&#x8FD0;&#x884C; main &#x51FD;&#x6570;&#x524D;&#xFF0C;&#x5DF2;&#x7ECF;&#x6709;&#x975E;&#x5E38;&#x57FA;&#x672C;&#x7684;&#x7C7B;&#x5E93;&#x51FD;&#x6570;&#x88AB;&#x8C03;&#x7528;&#x4E86;&#x3002;</p>
<h2 class="mume-header" id="6-agent-%E6%97%B6%E5%BA%8F%E5%9B%BE">6. Agent &#x65F6;&#x5E8F;&#x56FE;</h2>

<p>&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;<br>
<img src="https://raw.githubusercontent.com/jiangwei618/note/master/assets/image/2JVMTI_interface.md-2019-08-06-15-06-44.png" alt></p>
<h2 class="mume-header" id="7-%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8Ejava-agent">7. &#x8865;&#x5145;&#x8BF4;&#x660E;&#xFF1A;Java Agent</h2>

<p>&#x6211;&#x4EEC;&#x901A;&#x8FC7;-javaagent &#x6765;&#x6307;&#x5B9A;&#x6211;&#x4EEC;&#x7F16;&#x5199;&#x7684; agent &#x7684; jar &#x8DEF;&#x5F84;&#xFF08;./myagent.jar&#xFF09;&#xFF0C;&#x4EE5;&#x53CA;&#x8981;&#x4F20;&#x7ED9; agent &#x7684;&#x53C2;&#x6570;&#xFF08;mode=test&#xFF09;&#xFF0C;&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x8FD9;&#x4E2A; agent &#x5C31;&#x53EF;&#x4EE5;&#x505A;&#x4E00;&#x4E9B;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x7684;&#x4E8B;&#x4E86;&#x3002;</p>
<p>javaagent &#x7684;&#x4E3B;&#x8981;&#x529F;&#x80FD;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>&#x53EF;&#x4EE5;&#x5728;&#x52A0;&#x8F7D; class &#x6587;&#x4EF6;&#x4E4B;&#x524D;&#x505A;&#x62E6;&#x622A;&#xFF0C;&#x5BF9;&#x5B57;&#x8282;&#x7801;&#x505A;&#x4FEE;&#x6539;<br>
&#x53EF;&#x4EE5;&#x5728;&#x8FD0;&#x884C;&#x671F;&#x5BF9;&#x5DF2;&#x52A0;&#x8F7D;&#x7C7B;&#x7684;&#x5B57;&#x8282;&#x7801;&#x505A;&#x53D8;&#x66F4;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x6709;&#x5F88;&#x591A;&#x7684;&#x9650;&#x5236;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x8BE6;&#x7EC6;&#x8BF4;</li>
<li>&#x83B7;&#x53D6;&#x6240;&#x6709;&#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x8FC7;&#x7684;&#x7C7B;</li>
<li>&#x83B7;&#x53D6;&#x6240;&#x6709;&#x5DF2;&#x7ECF;&#x521D;&#x59CB;&#x5316;&#x8FC7;&#x7684;&#x7C7B;&#xFF08;&#x6267;&#x884C;&#x8FC7; clinit &#x65B9;&#x6CD5;&#xFF0C;&#x662F;&#x4E0A;&#x9762;&#x7684;&#x4E00;&#x4E2A;&#x5B50;&#x96C6;&#xFF09;</li>
<li>&#x83B7;&#x53D6;&#x67D0;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x5927;&#x5C0F;</li>
<li>&#x5C06;&#x67D0;&#x4E2A; jar &#x52A0;&#x5165;&#x5230; bootstrap classpath &#x91CC;&#x4F5C;&#x4E3A;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x88AB; bootstrapClassloader &#x52A0;&#x8F7D;</li>
<li>&#x5C06;&#x67D0;&#x4E2A; jar &#x52A0;&#x5165;&#x5230; classpath &#x91CC;&#x4F9B; AppClassloard &#x53BB;&#x52A0;&#x8F7D;</li>
<li>&#x8BBE;&#x7F6E;&#x67D0;&#x4E9B; native &#x65B9;&#x6CD5;&#x7684;&#x524D;&#x7F00;&#xFF0C;&#x4E3B;&#x8981;&#x5728;&#x67E5;&#x627E; native &#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x505A;&#x89C4;&#x5219;&#x5339;&#x914D;</li>
</ol>
<p>&#x2003;&#x2003;JavaAgent&#xFF0C;&#x5FC5;&#x987B;&#x8981;&#x8BB2;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x53EB;&#x505A; instrument &#x7684; JVMTIAgent&#xFF08;Linux &#x4E0B;&#x5BF9;&#x5E94;&#x7684;&#x52A8;&#x6001;&#x5E93;&#x662F; <a href="http://libinstrument.so">libinstrument.so</a>&#xFF09;&#xFF0C;&#x56E0;&#x4E3A; javaagent &#x529F;&#x80FD;&#x5C31;&#x662F;&#x5B83;&#x6765;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x53E6;&#x5916; instrument agent &#x8FD8;&#x6709;&#x4E2A;&#x522B;&#x540D;&#x53EB; JPLISAgent(Java Programming Language Instrumentation Services Agent)&#xFF0C;&#x8FD9;&#x4E2A;&#x540D;&#x5B57;&#x4E5F;&#x5B8C;&#x5168;&#x4F53;&#x73B0;&#x4E86;&#x5176;&#x6700;&#x672C;&#x8D28;&#x7684;&#x529F;&#x80FD;&#xFF1A;&#x5C31;&#x662F;&#x4E13;&#x95E8;&#x4E3A; Java &#x8BED;&#x8A00;&#x7F16;&#x5199;&#x7684;&#x63D2;&#x6869;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x652F;&#x6301;&#x7684;&#x3002;</p>
<p>instrument agent &#x7684;&#x6838;&#x5FC3;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="C" class="language-c"><span class="token keyword">struct</span> _JPLISAgent <span class="token punctuation">{</span>
    JavaVM <span class="token operator">*</span>                mJVM<span class="token punctuation">;</span>                   <span class="token comment">/* handle to the JVM */</span>
    JPLISEnvironment        mNormalEnvironment<span class="token punctuation">;</span>     <span class="token comment">/* for every thing but retransform stuff */</span>
    JPLISEnvironment        mRetransformEnvironment<span class="token punctuation">;</span><span class="token comment">/* for retransform stuff only */</span>
    jobject                 mInstrumentationImpl<span class="token punctuation">;</span>   <span class="token comment">/* handle to the Instrumentation instance */</span>
    jmethodID               mPremainCaller<span class="token punctuation">;</span>         <span class="token comment">/* method on the InstrumentationImpl that does the premain stuff (cached to save lots of lookups) */</span>
    jmethodID               mAgentmainCaller<span class="token punctuation">;</span>       <span class="token comment">/* method on the InstrumentationImpl for agents loaded via attach mechanism */</span>
    jmethodID               mTransform<span class="token punctuation">;</span>             <span class="token comment">/* method on the InstrumentationImpl that does the class file transform */</span>
    jboolean                mRedefineAvailable<span class="token punctuation">;</span>     <span class="token comment">/* cached answer to &quot;does this agent support redefine&quot; */</span>
    jboolean                mRedefineAdded<span class="token punctuation">;</span>         <span class="token comment">/* indicates if can_redefine_classes capability has been added */</span>
    jboolean                mNativeMethodPrefixAvailable<span class="token punctuation">;</span> <span class="token comment">/* cached answer to &quot;does this agent support prefixing&quot; */</span>
    jboolean                mNativeMethodPrefixAdded<span class="token punctuation">;</span>     <span class="token comment">/* indicates if can_set_native_method_prefix capability has been added */</span>
    <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>            mAgentClassName<span class="token punctuation">;</span>        <span class="token comment">/* agent class name */</span>
    <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>            mOptionsString<span class="token punctuation">;</span>         <span class="token comment">/* -javaagent options string */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> _JPLISEnvironment <span class="token punctuation">{</span>
    jvmtiEnv <span class="token operator">*</span>              mJVMTIEnv<span class="token punctuation">;</span>              <span class="token comment">/* the JVM TI environment */</span>
    JPLISAgent <span class="token operator">*</span>            mAgent<span class="token punctuation">;</span>                 <span class="token comment">/* corresponding agent */</span>
    jboolean                mIsRetransformer<span class="token punctuation">;</span>       <span class="token comment">/* indicates if special environment */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>&#x2003;&#x2003;&#x8FD9;&#x91CC;&#x89E3;&#x91CA;&#x4E00;&#x4E0B;&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x9879;&#xFF1A;</p>
<ol>
<li>
<p>mNormalEnvironment&#xFF1A;&#x4E3B;&#x8981;&#x63D0;&#x4F9B;&#x6B63;&#x5E38;&#x7684;&#x7C7B; transform &#x53CA; redefine &#x529F;&#x80FD;&#x3002;</p>
</li>
<li>
<p>mRetransformEnvironment&#xFF1A;&#x4E3B;&#x8981;&#x63D0;&#x4F9B;&#x7C7B; retransform &#x529F;&#x80FD;&#x3002;</p>
</li>
<li>
<p>mInstrumentationImpl&#xFF1A;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x975E;&#x5E38;&#x91CD;&#x8981;&#xFF0C;&#x4E5F;&#x662F;&#x6211;&#x4EEC; Java agent &#x548C; JVM &#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#x7684;&#x5165;&#x53E3;&#xFF0C;&#x6216;&#x8BB8;&#x5199;&#x8FC7; javaagent &#x7684;&#x4EBA;&#x5728;&#x5199; premain &#x4EE5;&#x53CA; agentmain &#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x6CE8;&#x610F;&#x5230;&#x4E86;&#x6709;&#x4E2A; Instrumentation &#x53C2;&#x6570;&#xFF0C;&#x8BE5;&#x53C2;&#x6570;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x8FD9;&#x91CC;&#x7684;&#x5BF9;&#x8C61;&#x3002;</p>
</li>
<li>
<p>mPremainCaller&#xFF1A;&#x6307;&#x5411; sun.instrument.InstrumentationImpl.loadClassAndCallPremain &#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C; agent &#x662F;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x52A0;&#x8F7D;&#x7684;&#xFF0C;&#x5219;&#x8BE5;&#x65B9;&#x6CD5;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#x3002;</p>
</li>
<li>
<p>mAgentmainCaller&#xFF1A;&#x6307;&#x5411; sun.instrument.InstrumentationImpl.loadClassAndCallAgentmain &#x65B9;&#x6CD5;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x5728;&#x901A;&#x8FC7; attach &#x7684;&#x65B9;&#x5F0F;&#x52A8;&#x6001;&#x52A0;&#x8F7D; agent &#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#x3002;</p>
</li>
<li>
<p>mTransform&#xFF1A;&#x6307;&#x5411; sun.instrument.InstrumentationImpl.transform &#x65B9;&#x6CD5;&#x3002;</p>
</li>
<li>
<p>mAgentClassName&#xFF1A;&#x5728;&#x6211;&#x4EEC; javaagent &#x7684; MANIFEST.MF &#x91CC;&#x6307;&#x5B9A;&#x7684; Agent-Class&#x3002;</p>
</li>
<li>
<p>mOptionsString&#xFF1A;&#x4F20;&#x7ED9; agent &#x7684;&#x4E00;&#x4E9B;&#x53C2;&#x6570;&#x3002;</p>
</li>
<li>
<p>mRedefineAvailable&#xFF1A;&#x662F;&#x5426;&#x5F00;&#x542F;&#x4E86; redefine &#x529F;&#x80FD;&#xFF0C;&#x5728; javaagent &#x7684; MANIFEST.MF &#x91CC;&#x8BBE;&#x7F6E; Can-Redefine-Classes:true&#x3002;</p>
</li>
<li>
<p>mNativeMethodPrefixAvailable&#xFF1A;&#x662F;&#x5426;&#x652F;&#x6301; native &#x65B9;&#x6CD5;&#x524D;&#x7F00;&#x8BBE;&#x7F6E;&#xFF0C;&#x540C;&#x6837;&#x5728; javaagent &#x7684; MANIFEST.MF &#x91CC;&#x8BBE;&#x7F6E; Can-Set-Native-Method-Prefix:true&#x3002;</p>
</li>
<li>
<p>mIsRetransformer&#xFF1A;&#x5982;&#x679C;&#x5728; javaagent &#x7684; MANIFEST.MF &#x6587;&#x4EF6;&#x91CC;&#x5B9A;&#x4E49;&#x4E86; Can-Retransform-Classes:true&#xFF0C;&#x5C06;&#x4F1A;&#x8BBE;&#x7F6E; mRetransformEnvironment &#x7684; mIsRetransformer &#x4E3A; true&#x3002;</p>
</li>
</ol>
<h2 class="mume-header" id="8-%E5%9C%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E5%8A%A0%E8%BD%BD-instrument-agent">8. &#x5728;&#x542F;&#x52A8;&#x65F6;&#x52A0;&#x8F7D; instrument agent</h2>

<p>&#x2003;&#x2003;&#x6B63;&#x5982;&#x524D;&#x9762;&#x201C;&#x6982;&#x8FF0;&#x201D;&#x91CC;&#x63D0;&#x5230;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5C31;&#x662F;&#x542F;&#x52A8;&#x65F6;&#x52A0;&#x8F7D; instrument agent&#xFF0C;&#x5177;&#x4F53;&#x8FC7;&#x7A0B;&#x90FD;&#x5728; InvocationAdapter.c &#x7684; Agent_OnLoad &#x65B9;&#x6CD5;&#x91CC;&#xFF0C;&#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x63CF;&#x8FF0;&#x4E0B;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<ol>
<li>&#x521B;&#x5EFA;&#x5E76;&#x521D;&#x59CB;&#x5316; JPLISAgent</li>
<li>&#x76D1;&#x542C; VMInit &#x4E8B;&#x4EF6;&#xFF0C;&#x5728; vm &#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#x505A;&#x4E0B;&#x9762;&#x7684;&#x4E8B;&#x60C5;&#xFF1A;</li>
<li>&#x521B;&#x5EFA; InstrumentationImpl &#x5BF9;&#x8C61;</li>
<li>&#x76D1;&#x542C; ClassFileLoadHook &#x4E8B;&#x4EF6;</li>
<li>&#x8C03;&#x7528; InstrumentationImpl &#x7684; loadClassAndCallPremain &#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x91CC;&#x4F1A;&#x8C03;&#x7528; javaagent &#x91CC; MANIFEST.MF &#x91CC;&#x6307;&#x5B9A;&#x7684; Premain-Class &#x7C7B;&#x7684; premain &#x65B9;&#x6CD5;<br>
&#x89E3;&#x6790; javaagent &#x91CC; MANIFEST.MF &#x91CC;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x8FD9;&#x4E9B;&#x53C2;&#x6570;&#x6765;&#x8BBE;&#x7F6E; JPLISAgent &#x91CC;&#x7684;&#x4E00;&#x4E9B;&#x5185;&#x5BB9;</li>
</ol>
<h2 class="mume-header" id="9-%E5%9C%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8A%A0%E8%BD%BD-instrument-agent">9. &#x5728;&#x8FD0;&#x884C;&#x65F6;&#x52A0;&#x8F7D; instrument agent</h2>

<p>&#x2003;&#x2003;&#x4E0A;&#x9762;&#x4F1A;&#x901A;&#x8FC7; JVM &#x7684; attach &#x673A;&#x5236;&#x6765;&#x8BF7;&#x6C42;&#x76EE;&#x6807; JVM &#x52A0;&#x8F7D;&#x5BF9;&#x5E94;&#x7684; agent&#xFF0C;&#x8FC7;&#x7A0B;&#x5927;&#x81F4;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>
<p>&#x521B;&#x5EFA;&#x5E76;&#x521D;&#x59CB;&#x5316; JPLISAgent</p>
</li>
<li>
<p>&#x89E3;&#x6790; javaagent &#x91CC; MANIFEST.MF &#x91CC;&#x7684;&#x53C2;&#x6570;</p>
</li>
<li>
<p>&#x521B;&#x5EFA; InstrumentationImpl &#x5BF9;&#x8C61;</p>
</li>
<li>
<p>&#x76D1;&#x542C; ClassFileLoadHook &#x4E8B;&#x4EF6;</p>
</li>
<li>
<p>&#x8C03;&#x7528; InstrumentationImpl &#x7684; loadClassAndCallAgentmain &#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x91CC;&#x4F1A;&#x8C03;&#x7528; javaagent &#x91CC; MANIFEST.MF &#x91CC;&#x6307;&#x5B9A;&#x7684; Agent-Class &#x7C7B;&#x7684; agentmain &#x65B9;&#x6CD5;<br>
&#x2003;&#x2003;&#x5728;&#x8FD0;&#x884C;&#x65F6;&#x52A0;&#x8F7D; instrument agent &#x5927;&#x81F4;&#x6309;&#x7167;&#x5982;&#x4E0B;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#xFF1A;</p>
</li>
<li>
<p>VirtualMachine vm = VirtualMachine.attach(pid); &#xFF08;&#x6839;&#x636E; PID &#x83B7;&#x53D6; &#x8FD0;&#x884C;&#x88AB;&#x76D1;&#x63A7;&#x7684; JVM &#x5B9E;&#x4F8B;&#xFF09;</p>
</li>
<li>
<p>vm.loadAgent(agentPath, agentArgs); &#xFF08;&#x901A;&#x77E5;&#x8BE5; JVM &#x53BB;&#x52A0;&#x8F7D; agent&#xFF09;</p>
</li>
</ol>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>